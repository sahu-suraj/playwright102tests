version: 0.1
globalTimeout: 90
testSuiteTimeout: 90
testSuiteStep: 90
autosplit: false
retryOnFailure: false
concurrency: 4

matrix:
  os: [win10, linux]
  browser: [chrome, firefox]

env:
  LT_USERNAME: ${{ secrets.LT_USERNAME }}
  LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}
  BASE_URL: "https://www.lambdatest.com/selenium-playground"
  OS: ${{ matrix.os }}
  BROWSER: ${{ matrix.browser }}

pre:
  - npm install
  - npx playwright install
  - echo "Dependencies installed"

cacheKey: '{{ checksum "package-lock.json" }}'
cacheDirectories:
  - node_modules

testSuites:
  - |
    node -e "let fs=require('fs');let cap=fs.readFileSync('capabilities.json','utf8');cap=cap.replace(/\${OS}/g,process.env.OS).replace(/\${BROWSER}/g,process.env.BROWSER);fs.writeFileSync('resolved-capabilities.json',cap);" \
    && npx jest --runInBand --maxWorkers=2

target:
  os: ${{ matrix.os }}
  browser: ${{ matrix.browser }}

post:
  - echo "Tests completed!"
  - mkdir -p artifacts
  - tar -czf artifacts/test-artifacts.tar.gz ./test-results || echo "No test-results dir"
